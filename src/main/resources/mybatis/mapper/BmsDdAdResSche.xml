<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kthcorp.daisy.bms.repository.BmsDdAdResScheMapper">

    <insert id="insertAdResSche" parameterType="com.kthcorp.daisy.bms.repository.entity.BmsDdAdResSche">
        /** insertAdResSche **/
        insert into bms_dd_ad_res_sche (
            yyyymmdd, sche_gubn, apln_form_id, ad_id, ad_nm, ad_length, ch_id, ch_no, ch_nm, brdcst_dt, start_dt, end_dt
        ) values (
            #{yyyymmdd}, #{sche_gubn}, #{apln_form_id}, #{ad_id}, #{ad_nm}, #{ad_length}, #{ch_id}, #{ch_no}, #{ch_nm}, #{brdcst_dt}, #{start_dt}, #{end_dt}
        )
    </insert>

    <select id="selAdminScheCheck" parameterType="java.util.LinkedHashMap" resultType="java.lang.Integer">
        /** selAdminScheCheck **/
        select count(1) from bms_dd_admin_ad_sche where brdcst_dt = '20180428' limit 1
    </select>

    <select id="selTmpScheNadminScheMergeForToDay" parameterType="java.util.LinkedHashMap" resultType="com.kthcorp.daisy.bms.repository.entity.BmsDdAdResSche">
        /** selTmpScheNadminScheMergeForToDay **/
        select
                d.yyyymmdd, d.sche_gubn, d.apln_form_id, d.ad_id, d.ad_nm, d.ad_length, d.ch_id, d.ch_no, d.ch_nm, d.brdcst_dt, d.start_dt, d.end_dt
        from    bms_dd_ad_tmp_res_sche d
        where   sche_gubn = '1'
        and     not exists
        (
            select
                    c.yyyymmdd, c.sche_gubn, c.apln_form_id, c.ad_id, c.ad_nm, c.ad_length, c.ch_id, c.ch_no, c.ch_nm, c.brdcst_dt, c.start_dt, c.end_dt
            from
            (
                select
                        a.yyyymmdd, a.sche_gubn, a.apln_form_id, a.ad_id, a.ad_nm, a.ad_length, a.ch_id, a.ch_no, a.ch_nm, a.brdcst_dt, a.start_dt, a.end_dt
                from
                (
                    select
                            yyyymmdd, sche_gubn, apln_form_id, ad_id, ad_nm, ad_length, ch_id, ch_no, ch_nm, brdcst_dt, start_dt, end_dt
                    from    bms_dd_ad_tmp_res_sche
                    where   brdcst_dt = #{brdcst_dt}
                    and     sche_gubn = '1'
                ) a
                join
                (
                    select
                            yyyymmdd, sche_gubn, apln_form_id, ad_id, ad_nm, ad_length, ch_id, ch_no, ch_nm, brdcst_dt, start_dt, end_dt
                    from    bms_dd_admin_ad_sche where brdcst_dt = #{brdcst_dt}
                ) b
                on a.brdcst_dt = b.brdcst_dt
                and
                (
                    substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ <= ]]> substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
                    and
                    substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ < ]]> substr(to_char(to_timestamp(a.end_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
                )
                or substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) = substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            --and     substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ <= ]]> substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            --and     substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) = substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            ) c
        where   c.apln_form_id = d.apln_form_id and c.ad_id = d.ad_id and c.ch_id = d.ch_id
        )
    </select>

    <select id="selTmpScheNadminScheMergeForNextDay" parameterType="java.util.LinkedHashMap" resultType="com.kthcorp.daisy.bms.repository.entity.BmsDdAdResSche">
        /** selTmpScheNadminScheMergeForNextDay **/
        select
                d.yyyymmdd, d.sche_gubn, d.apln_form_id, d.ad_id, d.ad_nm, d.ad_length, d.ch_id, d.ch_no, d.ch_nm, d.brdcst_dt, d.start_dt, d.end_dt
        from    bms_dd_ad_tmp_res_sche d
        where   sche_gubn = '2'
        and     not exists
        (
            select
                    c.yyyymmdd, c.sche_gubn, c.apln_form_id, c.ad_id, c.ad_nm, c.ad_length, c.ch_id, c.ch_no, c.ch_nm, c.brdcst_dt, c.start_dt, c.end_dt
            from
            (
                select
                        a.yyyymmdd, a.sche_gubn, a.apln_form_id, a.ad_id, a.ad_nm, a.ad_length, a.ch_id, a.ch_no, a.ch_nm, a.brdcst_dt, a.start_dt, a.end_dt
                from
                (
                    select
                            yyyymmdd, sche_gubn, apln_form_id, ad_id, ad_nm, ad_length, ch_id, ch_no, ch_nm, brdcst_dt, start_dt, end_dt
                    from    bms_dd_ad_tmp_res_sche
                    where   brdcst_dt = #{brdcst_dt}
                    and     sche_gubn = '2'
                ) a
                join
                (
                    select
                            yyyymmdd, sche_gubn, apln_form_id, ad_id, ad_nm, ad_length, ch_id, ch_no, ch_nm, brdcst_dt, start_dt, end_dt
                    from    bms_dd_admin_ad_sche where brdcst_dt = #{brdcst_dt}
                ) b
                on a.brdcst_dt = b.brdcst_dt
                and
                (
                    substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ <= ]]> substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
                    and
                    substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ < ]]> substr(to_char(to_timestamp(a.end_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
                )
                or substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) = substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            --and     substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) <![CDATA[ <= ]]> substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            --and     substr(to_char(to_timestamp(b.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10) = substr(to_char(to_timestamp(a.start_dt, 'yyyy-MM-dd HH24:MI:SS'), 'yyyyMMddHH24MISS'),1,10)
            ) c
        where   c.apln_form_id = d.apln_form_id and c.ad_id = d.ad_id and c.ch_id = d.ch_id
        )
    </select>

</mapper>